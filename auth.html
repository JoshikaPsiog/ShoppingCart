<body>
    <h2>Login with Google</h2>
    <button id="googleBtn">Login with Google</button>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const CLIENT_ID = "41311417043-t30ieu5fgspi7ca6rqi4p3eljqld8lcf.apps.googleusercontent.com";
        const API_KEY = "AIzaSyC5kYvCD9088m14VuzEjJwGmYKLFI-79EA";
        const PROJECT_ID = "shoppingcart-4b24e";
        const REDIRECT_URI = "http://127.0.0.1:5500/auth.html";

        // ✅ Google login redirect
        function loginWithGoogle() {
            const oauthUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=openid email profile&prompt=select_account`;
            window.location = oauthUrl;
        }

        // ✅ Handle Firebase + Firestore login
        async function handleLogin(accessToken) {
            try {
                // 1️⃣ Sign in with Firebase Auth REST API using Google Access Token
                const firebaseResp = await axios.post(
                    `https://identitytoolkit.googleapis.com/v1/accounts:signInWithIdp?key=${API_KEY}`,
                    {
                        postBody: `access_token=${accessToken}&providerId=google.com`,
                        requestUri: REDIRECT_URI,
                        returnSecureToken: true,
                        returnIdpCredential: true
                    }
                );

                const uid = firebaseResp.data.localId;
                const idToken = firebaseResp.data.idToken;
                const email = firebaseResp.data.email;

                // 2️⃣ Firestore: Check if user document exists
                const userDocRef = `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents/users/${uid}`;
                let role = "user"; // default role

                try {
                    const resp = await axios.get(userDocRef, {
                        headers: { Authorization: `Bearer ${idToken}` }
                    });
                    role = resp.data.fields.role.stringValue || "user";
                } catch (err) {
                    // Create new user document if not found
                    if (err.response?.status === 404) {
                        await axios.patch(
                            `${userDocRef}?currentDocument.exists=false`,
                            {
                                fields: {
                                    email: { stringValue: email },
                                    role: { stringValue: "user" } // only user by default
                                }
                            },
                            { headers: { Authorization: `Bearer ${idToken}` } }
                        );
                    } else {
                        throw err;
                    }
                }

                // 3️⃣ Save session info
                sessionStorage.setItem("uid", uid);
                sessionStorage.setItem("idToken", idToken);
                sessionStorage.setItem("role", role);

                // 4️⃣ Redirect
                window.location = "dashboard.html";

            } catch (err) {
                console.error(err);
                alert("Google login failed: " + (err.response?.data?.error?.message || err));
            }
        }

        // ✅ Handle redirect from Google OAuth
        window.onload = () => {
            document.getElementById("googleBtn").addEventListener("click", loginWithGoogle);

            if (window.location.hash) {
                const hash = window.location.hash.substring(1);
                const params = new URLSearchParams(hash);
                const accessToken = params.get("access_token");

                if (accessToken) {
                    handleLogin(accessToken);
                }
            }
        };
    </script>
</body>
